name: Sync RSVP Data

on:
  schedule:
    # Run every 15 minutes
    - cron: "0 * * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - name: Init Hermit
        uses: cashapp/activate-hermit@v1
      - name: Run sync command
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          MACHINE_IDS=$(flyctl machine list --json | jq -r '.[].id')
          for MACHINE_ID in $MACHINE_IDS; do
            echo "Syncing on machine: $MACHINE_ID"
            flyctl machine start $MACHINE_ID || true
            flyctl ssh console --machine $MACHINE_ID -C "/app/server sync"
          done
