# LiteFS configuration for multi-region replication
# See: https://fly.io/docs/litefs/config/

# Path where the FUSE mount will be located
fuse:
  dir: "/litefs"

# Data directory for LiteFS internal use
# This must be on a persistent volume
data:
  dir: "/var/lib/litefs"

# Proxy server configuration
# Routes write requests to primary node automatically
proxy:
  addr: ":8080"
  target: "localhost:8081"
  db: "wedding.db"

# Lease configuration for determining primary node
lease:
  type: "consul"
  
  # Specifies if this node can become primary
  # Only nodes in primary region can be candidates
  candidate: ${FLY_REGION == PRIMARY_REGION}
  
  # Auto-promote on startup to run migrations
  promote: true
  
  # The API URL that other nodes will use to connect to this node
  advertise-url: "http://${FLY_ALLOC_ID}.vm.${FLY_APP_NAME}.internal:20202"

  consul:
    url: "${FLY_CONSUL_URL}"
    key: "${FLY_APP_NAME}/primary"

# Exec commands - run migrations on candidates, then start server
exec:
  # Run migrations only on candidate nodes (primary region)
  - cmd: "/app/migrate.sh"
    if-candidate: true
  
  # Start the application server on all nodes
  - cmd: "/app/server serve"
